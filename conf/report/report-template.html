{% if False %}
<!-- vim: set ts=2 sts=2 sw=2 et: -->
{% endif %}
<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>SystemVerilog Report</title>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">

    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.css">
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/fixedheader/3.1.5/js/dataTables.fixedHeader.min.js"> </script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/fixedheader/3.1.5/css/fixedHeader.dataTables.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
    <link rel="stylesheet" type="text/css" href="report.css">
    <script type="text/javascript" charset="utf8" src="report.js"></script>
  </head>

  <script>
    function Filter(id, mode, condition, value) {
      this.id = id;
      this.mode = mode;
      this.condition = condition;
      this.value = value;
    }

    var iter = 1;
    var filters = [];
    var value;
    var apply_active = false;

    function removeFilter(object){
      var current_value = object.id;
      current_value = parseInt(current_value.charAt(current_value.length-1));
      var index = filters.findIndex(obj => obj.id === current_value);
      if(current_value === iter-1 || current_value === iter-2){
        $('#new_filter_options_'+current_value).remove();
        $('#remove_'+current_value).remove();
        current_object = filters[index];
        mode = current_object.mode;

        if(mode === "coverage"){
          $('#operator_filter_'+current_value).remove();
          $('#coverage_filter_'+current_value).remove();
        }
        if(mode === "type"){
          $('#type_condition_filter_'+current_value).remove();
          $('#type_filter_'+current_value).remove();
        }
        if(mode === "tool"){
          $('#tool_condition_filter_'+current_value).remove();
          $('#tool_filter_'+current_value).remove();
        }
      }
      else
        $('#new_options_wrapper_'+current_value).remove();
      filters.splice(index, 1);
    }

    function removeAll() {
      $('#filter_wrapper').remove();
      iter = 1;
      var div = $('<div id="filter_wrapper"><button id="mainButton" onclick="addOptions()">Add</button></div>').insertAfter('#headline');
      filters.length = 0;
    }

    function applyFilter() {
      apply_active = true;
      if(!document.getElementById('removeButton'))
        var remove_all = $('<button id="removeButton" onclick="removeAll()">Remove all filters</button>').insertAfter('#applyButton');
      
      report = $('#report_table').DataTable();
      var num_filters = filters.length;
      var coverage, coverage_operator, type, type_operator, tool, tool_operator;
      for(var i=0; i<num_filters; i++){
        if(filters[i].mode === 'coverage'){
          coverage_operator = filters[i].condition;
          coverage = filters[i].value;
        }
        if(filters[i].mode === 'type'){
          type_operator = filters[i].condition;
          type = filters[i].value;
        }
        if(filters[i].mode === 'tool'){
          tool_operator = filters[i].condition;
          tool = filters[i].value;
        }
      }

      report.columns().every(function() {
        var column = this;
        if(column.index() !== 0 && column.index() !== 1) {
          var theadname = column.header().textContent.trim();

          if(tool_operator === 'is'){
            if(theadname === tool){
              var array = [];
              coverage = parseInt(coverage);
              column.data().each(function(d, j) {
                output = d.split('/');
                tests_passed = output[0];
                total_tests = output[1];
                percentage = parseInt((tests_passed/total_tests)*100);
                
                console.log(coverage_operator, coverage)
                if (coverage_operator === '<'){
                  if(percentage < coverage){
                    array.push('^'+d+'$');
                  }
                }
                if (coverage_operator === '<='){
                  if(percentage <= coverage){
                    array.push('^'+d+'$');
                  }
                }
                if (coverage_operator === '>'){
                  if(percentage > coverage){
                    array.push('^'+d+'$');
                  }
                }
                if (coverage_operator === '>='){
                  if(percentage >= coverage){
                    array.push('^'+d+'$');
                  }
                }
                if (coverage_operator === '='){
                  if(percentage === coverage){
                    array.push('^'+d+'$');
                  }
                }
              });
              array = array.join('|');
              column.search(array, true, false, true).draw();
            }
          }
        }
      });
    }
    
    function addOptions() {
      var tool, operator, percentage, type;
      var toolnames = [];
      $("#report_table thead tr th a").each(function(){
          toolnames.push(this.innerHTML);
        });
      if(iter > 1) {
        $('#secondaryButton').remove();
        $('#applyButton').remove();
        $('#removeButton').remove();
      }
      var div = $('<div id=""></div>').attr('id', "new_options_wrapper_"+iter).appendTo('#filter_wrapper');
      var options =  $('<select id=""><option value="Select"></option></select>').attr('id', "new_filter_options_"+iter)
                      .appendTo('#new_options_wrapper_'+iter)
                      .on('change', function(){
                        value = $(this).val();
                        current_value = $(this).attr("id");
                        current_value = parseInt(current_value.charAt(current_value.length-1));
                        
                        var current_filter;
                        if(filters.length < current_value){
                          current_filter = new Filter();
                          current_filter.id = current_value;
                          filters.push(current_filter);
                        }

                        if(value == "coverage"){
                          var current_object = filters.find(obj => obj.id === current_value);
                          current_object.mode = "coverage";
                          if(document.getElementById('type_filter_'+current_value)){
                            $('#type_condition_filter_'+current_value).remove();
                            $('#type_filter_'+current_value).remove();
                          }
                          if(document.getElementById('tool_filter_'+current_value)){
                            $('#tool_condition_filter_'+current_value).remove();
                            $('#tool_filter_'+current_value).remove();
                          }
                          
                          var operators = $('<select id=""><option value="Select"></option></select>').attr('id', "operator_filter_"+current_value).insertAfter(options)
                                        .on('change', function(){
                                          operator = $(this).val();
                                          current_object.condition = operator;
                                        })
                          var coverage = $('<select id=""><option value="Select"></option></select>').attr('id', "coverage_filter_"+current_value).insertAfter(operators)
                                        .on('change', function(){
                                          percentage = $(this).val();
                                          current_object.value = percentage;
                                        })
                          if(!document.getElementById('remove_'+current_value))
                            var remove = $('<i id="" class="fas fa-minus-circle" onclick="removeFilter(this)"></i>').attr('id', "remove_"+current_value).insertAfter(coverage);
                          
                          operators.append('<option value="<"> < </option>');
                          operators.append('<option value="<="> <= </option>');
                          operators.append('<option value=">"> > </option>');
                          operators.append('<option value=">="> >= </option>');
                          for(var i=1; i<=100; i++){
                            $('<option value="">'+i+'</option>').attr('value', i).appendTo(coverage);
                          }
                        }

                        if(value == "type"){
                          var current_object = filters.find(obj => obj.id === current_value);
                          current_object.mode = "type";
                          if(document.getElementById('coverage_filter_'+current_value)){
                            $('#operator_filter_'+current_value).remove();
                            $('#coverage_filter_'+current_value).remove();
                          }
                          if(document.getElementById('tool_filter_'+current_value)){
                            $('#tool_condition_filter_'+current_value).remove();
                            $('#tool_filter_'+current_value).remove();
                          }

                          var type_condition = $('<select id=""><option value="Select"></option></select>').attr('id', "type_condition_filter_"+current_value).insertAfter(options)
                                                  .on('change', function(){
                                                    operator = $(this).val();
                                                    current_object.condition = operator;
                                                  })
                          var types = $('<select id=""><option value="Select"></option></select>').attr('id', "type_filter_"+current_value).insertAfter(type_condition)
                                        .on('change', function(){
                                          type = $(this).val();
                                          current_object.value = type;
                                        })
                          if(!document.getElementById('remove_'+current_value))
                            var remove = $('<i id="" class="fas fa-minus-circle" onclick="removeFilter(this)"></i>').attr('id', "remove_"+current_value).insertAfter(types);
                          
                          type_condition.append('<option value="is">is</option>');
                          type_condition.append('<option value="is not">is not</option>');
                          types.append('<option value="parsing">Parsing</option>');
                          types.append('<option value="preprocessing">Preprocessing</option>');
                          types.append('<option value="simulation">Simulation</option>');
                        }

                        if(value == "tool"){
                          var current_object = filters.find(obj => obj.id === current_value);
                          current_object.mode = "tool";
                          if(document.getElementById('coverage_filter_'+current_value)){
                            $('#operator_filter_'+current_value).remove();
                            $('#coverage_filter_'+current_value).remove();
                          }
                          if(document.getElementById('type_filter_'+current_value)){
                            $('#type_condition_filter_'+current_value).remove();
                            $('#type_filter_'+current_value).remove();
                          }
                          
                          var tool_condition = $('<select id=""><option value="Select"></option></select>').attr('id', "tool_condition_filter_"+current_value).insertAfter(options)
                                                  .on('change', function(){
                                                    operator = $(this).val();
                                                    current_object.condition = operator;
                                                  })
                          var tools = $('<select id=""><option value="Select"></option></select>').attr('id', "tool_filter_"+current_value).insertAfter(tool_condition)
                                        .on('change', function(){
                                          tool = $(this).val();
                                          current_object.value = tool;
                                        })
                          if(!document.getElementById('remove_'+current_value))
                            var remove = $('<i id="" class="fas fa-minus-circle" onclick="removeFilter(this)"></i>').attr('id', "remove_"+current_value).insertAfter(tools);

                          tool_condition.append('<option value="is">is</option>');
                          tool_condition.append('<option value="is not">is not</option>');
                          for(var i = 0; i < toolnames.length; i++){
                            $('<option value="">'+toolnames[i]+'</option>').attr('value', toolnames[i]).appendTo(tools);
                          }
                        }
                      })
        options.append('<option value="coverage">Test Coverage</option>');
        options.append('<option value="type">Test Type</option>');
        options.append('<option value="tool">Tool Name</option>');
        var add = $('<button id="secondaryButton" onclick="addOptions()">Add</button>').insertAfter(options);
        var apply = $('<button id="applyButton" onclick="applyFilter()">Apply</button>').insertAfter(add);
        if(iter === 1){
          $('#mainButton').remove();
        }
        iter = iter + 1;
  }

    $(document).ready( function () {
      $('#report_table').DataTable( {
        paging: false,
        fixedHeader: true,
        "order": [[ 1, "asc" ]],
        "columnDefs": [ { "type": "sv-id", targets: 1 },
                        { "orderable": false, targets: 0 }],
        "columns": [
          null,
          null,
          {% for tool in report %}
          { "orderDataType": "test-status" },
          {% endfor %}
        ]
      });
    } );
  </script>
  <style type="text/css">
    .report_table_result {
      width: calc(80% / {{ report.keys()|length}} );
    }
  </style>

  <body>
    <h1 class="headline"><a href="https://github.com/chipsalliance/sv-tests">SV-Tests</a></h1>
    <p class="headline"><a href="https://github.com/chipsalliance/sv-tests"><em>Test suite to check compliance with the SystemVerilog LRM by chapter as well as some real-world cores and test-cases.</em></a></p>
    <div id="filter_wrapper">
      <button id="mainButton" onclick="addOptions()">Add</button>
    </div>
    <table id="report_table">
      <thead>
        <tr class="fixed_header">
          <th class="col_header1">  </th>
          <th class="col_header2">  </th>
          {% for tool, tooldata in report|dictsort %}
          <th title='{{ report[tool]["version"] }}'>
            <a class="tool_link" target=_blank href='{{ report[tool]["url"] }}'>{{ tool.lower() }}</a>
          </th>
          {% endfor %}
        </tr>
      </thead>
        {% for tag, info in database.items() %}
        <tr>
          <th class="report_table_info" title="{{info}}">
            {% if tag in database_urls %}
            <a class="tag_link" target=_blank href="{{database_urls[tag]}}"> {{ info }} </a>
            {% else %}
            {{ info }}
            {% endif %}
          </th>
          <th class="report_table_tag" title="{{info}}"> {{ tag }} </th>
          {% for tool, tooldata in report|dictsort %}
          <th class="report_table_result {{ tooldata["tags"][tag]["status"] }}
            {% if "test-na" not in tooldata["tags"][tag]["status"] %} test-cell {% endif %}"
            {% if "test-varied" in tooldata["tags"][tag]["status"] %} style='background-size: {{'%0.0f' | format(100.0 * tooldata["tags"][tag]["passed-num"] / tooldata["tags"][tag]["logs"]|length) }}% 100%' {% endif %}
            {% if "test-na" not in tooldata["tags"][tag]["status"] %}
            id='{{tool}}-{{tag}}-cell'
            onclick='toggleLog("{{tool}}", "{{tag}}",
                               "{{tooldata["tags"][tag]["logs"][tooldata["tags"][tag]["head_test"]]["name"]}}")'
            {% endif %}
          >
            {% if "test-na" not in tooldata["tags"][tag]["status"] %}
            {{ tooldata["tags"][tag]["passed-num"] }}/{{ tooldata["tags"][tag]["logs"]|length }}
            {% endif %}
          </th>
          {% endfor %}
        </tr>
      {% endfor %}
      <tfoot class="report_footer">
        <tr class="report_summary_row">
          <th class="report_summary_header" colspan="2"> Total tests passed </th>

          {% for tool, tooldata in report|dictsort %}
          <th class="report_table_result test-varied" style='background-size: {{'%0.0f'| format(100.0 * report[tool]["total"]["tests"] / report[tool]["tests"].keys()|length)}}% 100%;' title="{{ tool.lower() }} ({{'%0.0f'| format(100.0 * report[tool]["total"]["tests"] / report[tool]["tests"].keys()|length)}}%)" > {{ report[tool]["total"]["tests"] }}/{{ report[tool]["tests"].keys()|length }}</th>
          {% endfor %}
        </tr>
        <tr class="report_summary_row">
          <th class="report_summary_header" colspan="2"> Total tags passed </th>
          {% for tool, tooldata in report|dictsort %}
          <th class="report_table_result test-varied" style='background-size: {{'%0.0f'| format(100.0 * report[tool]["total"]["tags"] / report[tool]["total"]["tested_tags"])}}% 100%;' title="{{ tool.lower() }} ({{'%0.0f'| format(100.0 * report[tool]["total"]["tags"] / report[tool]["total"]["tested_tags"])}}%)" > {{ report[tool]["total"]["tags"]}}/{{ report[tool]["total"]["tested_tags"]}}</th>
          {% endfor %}
        </tr>
        <tr class="report_summary_row">
          <th class="report_summary_header" colspan="2"> Total time elapsed </th>
          {% for tool, tooldata in report|dictsort %}
          <th class="report_table_result" title="{{ tool.lower() }}" >
            {{'%0.0f'| format(report[tool]["time_elapsed"])}}s </th>
          {% endfor %}
        </tr>
        <tr class="report_summary_row">
          <th class="report_table_info gray_header" colspan="2"> User time elapsed </th>
          {% for tool, tooldata in report|dictsort %}
          <th class="report_table_result" title="{{ tool.lower() }}" >
            {{'%0.0f'| format(report[tool]["user_time"])}}s </th>
          {% endfor %}
        </tr>
        <tr class="report_summary_row">
          <th class="report_table_info gray_header" colspan="2"> System time elapsed </th>
          {% for tool, tooldata in report|dictsort %}
          <th class="report_table_result" title="{{ tool.lower() }}" >
            {{'%0.0f'| format(report[tool]["system_time"])}}s </th>
          {% endfor %}
        </tr>
        <tr class="report_summary_row">
          <th class="report_table_info gray_header" colspan="2"> Maximum ram usage </th>
          {% for tool, tooldata in report|dictsort %}
          <th class="report_table_result" title="{{ tool.lower() }}" >
            {{'%0.0f'| format(report[tool]["ram_usage"])}} MB </th>
          {% endfor %}
        </tr>
	<tr class="report_summary_row">
          <th class="report_table_info gray_header" colspan="2"> Average throughput passed for inputs &gt; 1KiB </th>
          {% for tool, tooldata in report|dictsort %}
          <th class="report_table_result" title="{{ tool.lower() }}" >
            {{'%0.0f'| format(report[tool]["passed_throughput"]|float)}} KiB/s </th>
          {% endfor %}
        </tr>
      </tfoot>
    </table>
    <br>
    <a class="download" href="report.csv">Download a summary in csv</a>
  </body>

  <br> <br>
  <footer id="footer">
    Generated using <a href="https://github.com/chipsalliance/sv-tests">sv-tests</a>,
    revision: <a href="https://github.com/chipsalliance/sv-tests/commit/{{revision}}">{{revision}}</a>,
    {% if build_id != 'local' %}
      {% set href = 'https://github.com/chipsalliance/sv-tests/actions/runs/' ~ build_id|string %}
      build_id: <a href="{{href}}">{{build_id}}</a>,
    {% else %}
      build_id: <a>{{build_id}}</a>,
    {% endif %}
    date: <a>{{datetime}}</a>.
  </footer>

  <div id="logfile-outer">
    <div class="iframe-wrap">
      <iframe class="iframe-log" name="log-frame"></iframe>
    </div>
    <div class="iframe-wrap">
      <iframe class="iframe-log" name="file-frame"></iframe>
    </div>
    {% for tag, info in database.items() %}
    {% for tool, tooldata in report.items() %}
    {% if "test-na" not in tooldata["tags"][tag]["status"] %}
    <div class="logfile"
         id="{{ tool }}-{{ tag }}-logfile">
      <div class="logtab-bar"
           id="logtab-{{tool}}-{{tag}}-bar">
        <button class="logtab-btn logtab-close-btn"
                onclick='toggleLog("{{tool}}", "{{tag}}", null)'>
          close
        </button>
        {% for test, output in tooldata["tags"][tag]["logs_sorted"] %}
        <button class="logtab-btn
                       logtab-tab-btn
                       {{output["status"]}}
                sorted
                "
                onclick='selectTab("{{output["fname"]}}",
                                   "logtab-btn-{{tool}}-{{tag}}-{{output["name"]}}",
                                   "{{output["first_file"]}}",
                                   "{{output["name"]}}")',
                id="logtab-btn-{{tool}}-{{tag}}-{{output['name']}}"
        >
          {{ output["name"] }}
        </button>
        {% endfor %}
      </div>
    </div>
    {% endif %}
    {% endfor %}
    {% endfor %}
  </div>

</html>
